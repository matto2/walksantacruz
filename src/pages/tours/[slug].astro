---
import { Image, getImage } from "astro:assets";
import { Icon } from "astro-icon/components";
import Layout from "../../layouts/Layout.astro";
import Lightbox from "../../components/Lightbox.astro";
import { tours, getTourBySlug, getRelatedTours } from "../../data/tours";
import mapBg from "../../assets/map-bg.jpg";
import surferDavidYao from "../../assets/surfer_david-yao_unsplash.jpg";

export async function getStaticPaths() {
  return tours.map((tour) => ({
    params: { slug: tour.slug },
    props: { tour },
  }));
}

const { tour } = Astro.props;
const relatedTours = getRelatedTours(tour.slug);

// Pre-process gallery images for lightbox
const processedGalleryImages = await Promise.all(
  tour.galleryImages.map(async (image) => {
    const optimizedImage = await getImage({ src: image.src, format: 'webp', quality: 80 });
    return {
      ...image,
      optimizedSrc: optimizedImage.src,
    };
  })
);

// Generate structured data for the tour (TourReservation schema)
const tourStructuredData = {
  "@context": "https://schema.org",
  "@type": "TouristAttraction",
  name: tour.title,
  description: tour.longDescription,
  image: tour.heroImage.src,
  url: `https://walksantacruz.com/tours/${tour.slug}`,
  address: {
    "@type": "PostalAddress",
    addressLocality: "Santa Cruz",
    addressRegion: "CA",
    addressCountry: "US",
  },
  touristType: ["Tourists", "Locals", "Families", "History Enthusiasts"],
  availableLanguage: ["English"],
  offers: {
    "@type": "Offer",
    price: "45.00",
    priceCurrency: "USD",
    availability: "https://schema.org/InStock",
    url: tour.bookingUrl,
    validFrom: new Date().toISOString().split("T")[0],
  },
};
---

<Layout
  title={tour.seoTitle}
  description={tour.seoDescription}
  image={tour.heroImage.src}
  type="article"
>
  <!-- Hero Image Section -->
  <section class="full-bleed relative">
    <div class="w-full">
      <Image
        src={tour.heroImage}
        alt={tour.heroImageAlt}
        class="w-full h-[400px] md:h-[500px] object-cover"
        loading="eager"
        quality={85}
      />
    </div>
  </section>

  <!-- Title and Breadcrumbs -->
  <section class="container py-8">
    <h1 class="text-4xl md:text-5xl font-bold text-center mb-4">
      {tour.title}
    </h1>

    <!-- Breadcrumb -->
    <nav class="mb-8" aria-label="Breadcrumb">
      <ol class="flex items-center justify-center gap-2 text-sm text-muted-foreground">
        <li><a href="/" class="hover:underline">Home</a></li>
        <Icon name="lucide:chevron-right" class="w-4 h-4" />
        <li><a href="/#tours" class="hover:underline">Tours</a></li>
        <Icon name="lucide:chevron-right" class="w-4 h-4" />
        <li aria-current="page" class="text-foreground font-semibold">
          {tour.title}
        </li>
      </ol>
    </nav>
  </section>

  <!-- Main Content -->
  <section class="container pb-16">
    <div class="max-w-3xl mx-auto">

      <!-- Trip Highlights -->
      <div class="mb-12">
        <h2 class="text-2xl md:text-3xl font-bold mb-6 text-[#e26f04]">
          Trip Highlights:
        </h2>
        <ul class="space-y-2">
          {tour.highlights.map((highlight) => (
            <li class="flex items-start gap-3">
              <span class="text-[#e26f04] mt-1">•</span>
              <span class="text-muted-foreground">{highlight}</span>
            </li>
          ))}
        </ul>
      </div>

      <!-- Book Your Tour -->
      <div class="mb-12 pb-8 border-b border-border">
        <h2 class="text-2xl md:text-3xl font-bold mb-6 text-[#e26f04]">
          Book Your Tour
        </h2>

        <div class="space-y-4 mb-6">
          <div>
            <span class="font-bold">ADULT:</span> ${tour.adultPrice}
          </div>
          <div>
            <span class="font-bold">CHILD (6-12):</span> ${tour.childPrice}
          </div>
          <div class="text-sm text-muted-foreground">
            5 and under FREE per adult ticket purchased
          </div>
        </div>

        <div class="mb-6">
          <div class="font-bold mb-2">Duration:</div>
          <div class="text-muted-foreground">{tour.duration}</div>
        </div>

        <div class="mb-6">
          <div class="font-bold mb-2">Schedule:</div>
          <div class="text-muted-foreground">{tour.schedule}</div>
        </div>

        <a href={tour.bookingUrl} class="btn btn-lg w-full md:w-auto">
          Buy Tickets
        </a>
      </div>

      <!-- Description -->
      <div class="mb-12">
        <h2 class="text-2xl md:text-3xl font-bold mb-6 text-[#e26f04] text-center">
          Description
        </h2>
        <div class="prose prose-lg max-w-none text-center">
          <p class="text-muted-foreground leading-relaxed">
            {tour.storytelling}
          </p>
        </div>
      </div>

      <!-- Important Information -->
      <div class="mb-12">
        <h2 class="text-2xl md:text-3xl font-bold mb-8 text-[#e26f04] text-center">
          Important Information
        </h2>

        <!-- Where does it start? -->
        <div class="mb-8 text-center">
          <h3 class="text-xl font-bold mb-4">Where does it start?</h3>
          <p class="text-muted-foreground mb-4">
            {tour.meetingPoint.name}
          </p>
          <a
            href={tour.meetingPoint.url}
            target="_blank"
            rel="noopener noreferrer"
            class="btn"
          >
            View on Map
          </a>
        </div>

        <!-- Private Tours -->
        <div class="mb-8 text-center">
          <h3 class="text-xl font-bold mb-4">Private Tours</h3>
          <p class="text-muted-foreground mb-4">
            We're happy to arrange private tours or build custom group tours for schools, corporate teams, non-profits, family reunions, and more.
          </p>
          <a href="/private-tours" class="btn">
            Make Inquiry
          </a>
        </div>

        <!-- Want a different tour? -->
        <div class="text-center">
          <h3 class="text-xl font-bold mb-4">Want a different tour?</h3>
          <p class="text-muted-foreground mb-4">
            We have many other tours to choose from in a variety of topics, languages, and group sizes.
          </p>
          <a href="/#tours" class="btn">
            See Other Tours
          </a>
        </div>
      </div>

      <!-- Gallery -->
      <div class="mb-12">
        <h2 class="text-2xl md:text-3xl font-bold mb-8 text-[#e26f04] text-center">
          Gallery
        </h2>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
          {processedGalleryImages.map((image, index) => (
            <div
              class="card overflow-hidden cursor-pointer hover:shadow-lg transition-shadow p-0"
              role="button"
              tabindex="0"
              data-lightbox-trigger
              data-lightbox-index={index}
              aria-label={`View ${image.alt} in lightbox`}
            >
              <img
                src={image.optimizedSrc}
                alt={image.alt}
                class="w-full h-64 object-cover"
                loading="lazy"
                data-lightbox-img
                data-caption={image.caption}
              />
            </div>
          ))}
        </div>
      </div>

      <!-- What Makes This Tour Special -->
      <div class="mb-12">
        <h2 class="text-2xl md:text-3xl font-bold mb-8 text-[#e26f04] text-center">
          What Makes This Tour Special
        </h2>

        <!-- Why take this tour? -->
        <div class="mb-8">
          <div class="rounded-lg overflow-hidden mb-6">
            <Image
              src={tour.slug === 'surfing-beach-culture' ? surferDavidYao : tour.heroImage}
              alt={tour.slug === 'surfing-beach-culture' ? 'Surfer at Santa Cruz' : tour.heroImageAlt}
              class="w-full h-64 object-cover"
              loading="lazy"
              quality={80}
            />
          </div>
          <h3 class="text-xl font-bold mb-4 text-center">Why take this tour?</h3>
          <p class="text-muted-foreground leading-relaxed text-center">
            {tour.longDescription}
          </p>
        </div>

        <!-- Included -->
        <div class="text-center">
          <h3 class="text-xl font-bold mb-4">Included</h3>
          <ul class="space-y-2 text-left max-w-xl mx-auto">
            {tour.includes.included.map((item) => (
              <li class="flex items-start gap-3">
                <span class="text-[#e26f04] mt-1">•</span>
                <span class="text-muted-foreground">{item}</span>
              </li>
            ))}
          </ul>
        </div>
      </div>

    </div>
  </section>

  <!-- Related Tours -->
  {
    relatedTours.length > 0 && (
      <section class="container py-16 md:py-24">
        <h2 class="text-2xl md:text-3xl font-bold mb-2 text-center">
          You Might Also Like
        </h2>
        <p class="text-center text-muted-foreground mb-8">
          Discover more of Santa Cruz with these tours
        </p>

        <div class="grid md:grid-cols-2 gap-6 max-w-4xl mx-auto">
          {relatedTours.map((relatedTour) => (
            <a
              href={`/tours/${relatedTour.slug}`}
              class="card bg-muted/50 hover:border-primary transition-all group block"
            >
              <div class="p-6">
                {/* Tour Image */}
                <div class="mb-4 rounded-lg overflow-hidden">
                  <Image
                    src={relatedTour.cardImage}
                    alt={relatedTour.cardImageAlt}
                    class="w-full h-40 object-cover group-hover:scale-105 transition-transform duration-300"
                    loading="lazy"
                    quality={75}
                  />
                </div>

                {/* Tour Title */}
                <h3 class="text-xl font-bold mb-3 group-hover:text-primary transition-colors">
                  {relatedTour.title}
                </h3>

                {/* Tour Pricing */}
                <div class="text-sm mb-4 space-y-1">
                  <div class="font-semibold text-foreground">ADULT: ${relatedTour.adultPrice}</div>
                  <div class="font-semibold text-foreground">CHILD (6-12): ${relatedTour.childPrice}</div>
                  <div class="text-xs text-muted-foreground">5 and under FREE per adult ticket purchased</div>
                </div>

                {/* Learn More Link */}
                <div class="flex items-center gap-2 text-primary font-semibold group-hover:gap-3 transition-all">
                  <span>Learn More</span>
                  <Icon name="lucide:arrow-right" class="w-4 h-4" />
                </div>
              </div>
            </a>
          ))}
        </div>
      </section>
    )
  }

  <!-- Final CTA Section -->
  <section class="container py-16 md:py-24">
    <div class="max-w-2xl mx-auto text-center card bg-primary/5 p-8 md:p-12">
      <Icon
        name="lucide:compass"
        class="w-16 h-16 text-primary mx-auto mb-6"
      />
      <h2 class="text-3xl md:text-4xl font-bold mb-4">
        Ready to Explore Santa Cruz?
      </h2>
      <p class="text-lg text-muted-foreground mb-8">
        Join us for this unforgettable walking tour. Book your spot today and
        discover the stories that make Santa Cruz special.
      </p>
      <a href={tour.bookingUrl} class="btn btn-lg">Book Your Tour Now</a>
      <p class="text-sm text-muted-foreground mt-6">
        Questions? Call or text us at <a
          href="tel:831-275-2566"
          class="text-primary hover:underline">831-275-2566</a
        >
      </p>
    </div>
  </section>

  <Lightbox />
</Layout>

<!-- Structured Data for SEO -->
<script
  type="application/ld+json"
  set:html={JSON.stringify(tourStructuredData)}
></script>
